---
- name: Ensure auditd logging settings are configured
  hosts: all
  become: true

  tasks:

    - name: Backup auditd.conf before modification
      ansible.builtin.copy:
        src: /etc/audit/auditd.conf
        dest: /etc/audit/auditd.conf.bak
        remote_src: true

    - name: Ensure max_log_file is set to 10
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file\s*='
        line: 'max_log_file = 10'
        backrefs: false

    - name: Ensure num_logs is set to 20
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^num_logs\s*='
        line: 'num_logs = 20'
        backrefs: false

    - name: Ensure max_log_file_action is set to rotate
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file_action\s*='
        line: 'max_log_file_action = rotate'
        backrefs: false

=====================

---
- name: Ensure auditd logging settings are configured
  hosts: all
  become: true
  tasks:

    - name: Backup auditd.conf before modification
      ansible.builtin.copy:
        src: /etc/audit/auditd.conf
        dest: /etc/audit/auditd.conf.bak
        remote_src: true

    - name: Ensure max_log_file is set to 10
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file\s*='
        line: 'max_log_file = 10'
        backrefs: false
      register: max_log

    - name: Ensure num_logs is set to 20
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^num_logs\s*='
        line: 'num_logs = 20'
        backrefs: false
      register: num_logs

    - name: Ensure max_log_file_action is set to rotate
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file_action\s*='
        line: 'max_log_file_action = rotate'
        backrefs: false
      register: action_log

    - name: Restart auditd if any config line changed
      ansible.builtin.service:
        name: auditd
        state: restarted
      when: max_log.changed or num_logs.changed or action_log.changed

=====================

---
- name: Ensure auditd logging and service settings are configured
  hosts: all
  become: true

  tasks:
    # STEP 1: Replace RefuseManualStart/Stop in the main unit file
    - name: Ensure RefuseManualStart is set to no
      ansible.builtin.replace:
        path: /usr/lib/systemd/system/auditd.service
        regexp: '^RefuseManualStart=yes'
        replace: 'RefuseManualStart=no'

    - name: Ensure RefuseManualStop is set to no
      ansible.builtin.replace:
        path: /usr/lib/systemd/system/auditd.service
        regexp: '^RefuseManualStop=yes'
        replace: 'RefuseManualStop=no'

    - name: Reload systemd daemon (daemon-reexec)
      ansible.builtin.command: systemctl daemon-reexec

    - name: Reload systemd (daemon-reload)
      ansible.builtin.command: systemctl daemon-reload

    # STEP 2: Backup auditd.conf before changes
    - name: Backup auditd.conf before modification
      ansible.builtin.copy:
        src: /etc/audit/auditd.conf
        dest: /etc/audit/auditd.conf.bak
        remote_src: true
        mode: '0644'

    # STEP 3: Modify auditd.conf parameters
    - name: Ensure max_log_file is set to 10
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file\s*='
        line: 'max_log_file = 10'
        backrefs: false

    - name: Ensure num_logs is set to 20
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^num_logs\s*='
        line: 'num_logs = 20'
        backrefs: false

    - name: Ensure max_log_file_action is set to rotate
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: '^max_log_file_action\s*='
        line: 'max_log_file_action = rotate'
        backrefs: false

    # STEP 4: Restart auditd
    - name: Restart auditd
      ansible.builtin.service:
        name: auditd
        state: restarted


