Folder Structure in S3:

s3://your-bucket-name/
│
├── incoming/       ← Upload .txt files here
├── encrypted/      ← Encrypted .pgp files saved here
└── archived/       ← Original .txt files moved here (or deleted)

Lambda Workflow (On .txt Upload to incoming/):
Triggered by .txt file upload to incoming/

Fetch PGP public key from Secrets Manager
Encrypt file using PGP
Save encrypted .pgp to encrypted/
Move original .txt to archived/ or delete it

Assumptions
PGP public key is stored in AWS Secrets Manager under a secret name like PGP_PUBLIC_KEY.
You're using Python for the Lambda.
Lambda has appropriate IAM permissions (S3, SecretsManager, etc.).

Full Lambda Code Example (Python)

import boto3
import gnupg
import os

s3 = boto3.client('s3')
secrets = boto3.client('secretsmanager')

gpg = gnupg.GPG(gnupghome='/tmp/.gnupg')

def lambda_handler(event, context):
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']

    if not key.startswith('incoming/') or not key.endswith('.txt'):
        return {'statusCode': 200, 'body': 'Not a target .txt file'}

    filename = os.path.basename(key)
    local_txt_path = f'/tmp/{filename}'
    encrypted_path = f'/tmp/{filename}.pgp'

    # Get the PGP public key from AWS Secrets Manager
    secret_response = secrets.get_secret_value(SecretId='PGP_PUBLIC_KEY')
    public_key = secret_response['SecretString']
    gpg.import_keys(public_key)

    # Download file from S3
    s3.download_file(bucket, key, local_txt_path)

    # Encrypt the file
    with open(local_txt_path, 'rb') as f:
        gpg.encrypt_file(f, output=encrypted_path, recipients=None, always_trust=True)

    # Upload encrypted file to 'encrypted/' folder
    s3.upload_file(encrypted_path, bucket, f'encrypted/{filename}.pgp')

    # Optional: move original to 'archived/' folder (or delete)
    s3.copy_object(
        Bucket=bucket,
        CopySource={'Bucket': bucket, 'Key': key},
        Key=f'archived/{filename}'
    )
    s3.delete_object(Bucket=bucket, Key=key)

    return {'statusCode': 200, 'body': f'{key} encrypted and moved successfully.'}
IAM Permissions Needed
Attach these permissions to your Lambda execution role:


{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject",
    "s3:DeleteObject",
    "s3:CopyObject",
    "secretsmanager:GetSecretValue"
  ],
  "Resource": "*"
}
(Refine Resource to be bucket-specific for production)

Storing the Public Key in AWS Secrets Manager

aws secretsmanager create-secret \
  --name PGP_PUBLIC_KEY \
  --secret-string file://public-key.asc
Or paste the armored key directly in the Secrets Manager UI.
